# Сервер математических моделей ИНК
Приложение позволяет производить вычисление параметров моделей с использованием клиент-серверной архитектуры.

## Минимальные системные требования

### Сервер
- ОС Ubuntu linux 18.04 / Debian 9
- python 3.6;
- СУБД PostgreSQL 12;
- nginx;
- uWSGI.

### Клиент
Любой из перечисленных web-браузеров:
- любой активно развиваемый браузер, имеющий не менее двух мажорных релизов;
- Chrome >= 60
- Firefox >= 60
- Firefox ESR
- iOS >= 12
- Safari >= 12
- IE 11

Таким образом, для мобильных устройств **поддерживаются последние версии** браузеров **Chrome, Firefox, Safari, Android browser**.
Для рабочих станций поддерживаются **последние версии** браузеров **Chrome, Firefox, Safari, Microsoft Edge, Opera**.

# Особенности
На концептуальном уровне, математические модели представляют собой совокупность алгоритмов, входных и выходных данных. 

На уровне приложения, модель `core.models.BaseMathModel` является наследником класса `django.db.models.Model` и содержит поля `user`, `input_data` и `output_data`. Последние два поля представляют собой встроенный в СУБД тип данных `jsonb`. Подобное решение хоть и противоречит каноничной реляционной теории баз данных в части нормализации, но имеет неоспоримые преимущества в гибкости. Добавление новых входных и выходных данных производится с минимальной модификацией программного кода.

За алгоримическую часть модели отвечает метод `calculate()`, который обращается к полям экземпляра класса модели, производит вычисления, записывает результат в `output_data` и возвращает вычисленные значения в вызывающий код. При вызове метода `save()` результат будет записан в СУБД. Метод `calculate()` порождает исключения `core.models.CalculationErrors` в случае ошибки во входных данных, либо при возникновении ошибки в ходе вычислений. Экземпляр исключения позволяет получить человеко-понятное пояснение при обращении к полю `e.message`. В данной демонстрационной версии приложения, для хранения входных данных и хранения промежуточных значений при вычислении используется встроенный в python тип данных `Decimal`, который обеспечивает точность до 28 знаков после запятой.

Приложение поддерживает работу с двумя видами математических моделей - синхронными, унаследованными от класса `core.models.BaseMathModel` и асинхронными, унаследованными от класса `core.models.AsyncMathModel`. Синхронные модели производят вычисления и возвращают результат пользователю в момент запроса. Асинхронные модели производят вычисления значительное время, поэтому пользователь получает уведомления о начале вычислений и об их окончании. После завершения вычислений пользователь может повторно обратиться к модели и получить результат. Таким образом, модели с малым количеством входных данных, и вычислениями продолжительностью менее 30 секунд можно отнести к синхронным, а модели, требующие работы с большим количеством данных или модели, производящие ресурсоемкие вычисления можно отнести к асинхронным. Класс `core.models.AsyncMathModel` помимо стандартных для математических моделей полей содержит так же два флага `is_ready` - флаг готовности результата, и `is_processing` - флаг выполнения вычислений в данный момент. Асинхронные модели в зависимости от значения флага `settings.DEBUG` выполняются в синхронном режиме, либо с использованием спулера uWSGI. Спулер позволяет осуществлять вычисления в отдельном процессе в порядке FIFO. Работа со спулером осуществляется в модуле `core.tasks`.

Экземпляры моделей создаются в момент обращения к ним пользователя, каждому пользователю ставится в соответствие свой экземпляр модели. Таким образом, приложение позовляет работать с математическими моделями большому количеству пользователей одновременно, каждый пользователь будет иметь свой набор входных данных и результатов.

Математические модели, доступные для пользователей, объявляются в константе `MATH_MODELS_AVAILABLE` модуля `math_model.settings`, модели можно группировать по тому или иному критерию. В данном приложении используется следующая структура для конфигурирования списка доступных моделей:
```
MATH_MODELS_AVAILABLE = {
    'Модели для скважин': [
        'core.models.WellProductionModel',
        'core.models.SimpleCalculatorModel',
        'core.models.AsyncCalculatorModel'
    ],
    'Прочие модели': [
        'core.models.SimpleCalculatorModel',
        'core.models.AsyncCalculatorModel'
    ]
}
```

Клиентская часть приложения представляет собой одностраничный тонкий клиент (SPA), реализованный средствами JS-фреймворка `Angularjs` и `Angular-UI Router`. За дизайн и структуру элементов пользовательского интерфейса отвечает CSS-фреймворк `Bootstrap v5.0`. Взаимодействие с серверной частью выполняется посредством REST-API. Клиент оптимизирован для работы с мобильными устройствами.

Приложение позволяет осуществлять разграничение прав доступа. Данная демонстрационная версия ограничивает возможность работы с приложением не аутентифициорованных пользователей. Ограничивается доступ как к web-интерфейсу, так и к REST-API. Возможно ограничение доступа пользователей к конкретным математическим моделям.

# Краткое руководство пользователя
## Вход и выход из приложения
Для входа в приложение заполните поля *логин* и *пароль* на экране входа.

![Экран входа](/materials/1.png)

Для выхода из приложения нажмите кнопку выход в правом верхнем углу экрана

![Кнопка выходы из приложения](/materials/2.png)

## Просмотр списка моделей
Сразу после входа, а так же при нажатии на название приложения в верхнем левом углу экрана, пользователю будет отображен список доступных математических моделий с кратким описанием. Список разделен на категории в зависимости от назначения моелей. Данный список можно отфильтровать путем ввода ключевых слов в поле *фильтр*. Для перехода к нужной модели нажмите на кнопку *перейти*

![Список математических моделей](/materials/3.png)

## Работа с синхронной математической моделью
Для работы с синхронной математической моделью, заполните все обязательные поля. В случае, если одно или несколько полей пропущены, либо введены некорректные данные, пользователь получит уведомление об ошибке валидации после нажатия на кнопку *произвести моделирование*. Внешний вид экрана синхронной модели **Прогнозирование добычи** представлен ниже.

![Модель прогнозирование добычи](/materials/4.png)

Для ввода табличных значений *отбор от НИЗ* нажмите на кнопку *редактировать*. Скопируйте три столбца **дата, отбор от НИЗ, обводненность** их файла excel в буфер обмена. Столбец **дата** должен содержать даты в формате дд.мм.гггг, столбцы **отбор от НИЗ** и **обводненность** должны содержать **десятичные числа с запятой**, используемой в качестве разделителя целой и дробной части. В случае, если одно из требований не соблюдено, либо буфер обмена пуст, пользователь получит уведомление об ошибке валидации данных. При работе с приложением впервые, требуется разрешить доступ приложению к буферу обмена (нажать *да* в появившемся диалоговом окне браузера). Для очистки таблицы от существующих значений нажмите кнопку *очистить*. Для сохранения вставленных из буфера обмена данных нажмите кнопку *сохранить*.

![Редактирование таблицы Отбор от НИЗ](/materials/5.png)

Модель **Прогнозирование добычи** позволяет ввести до трех референтных моделей, значения которых будут выведены на график вместе с вычисленным прогнозом. Для добавления референтной модели нажмите на кнопку *добавить модель*. В открывшемся окне введите название модели (ограничение - 50 символов) и вставьте из буфера обмена столбец со значениями для данной модели. Требования к числам те же, что и при заполнении таблицы *отбор от НИЗ*.

![Редактирование референтной модели](/materials/6.png) 

После ввода данных нажмите на кнопку *произвести моделирование*. Через пару секунд в правой части экрана (на мобильных устройствах снизу, после блока с исходными данными) вам будет отображен вычисленный результат. Вывод на график референтных моделей можно отключать путем нажатия на соответствующие кнопки под графиком. Для копирования таблицы *добыча в месяц* в буфер обмена нажмите на иконку блокнота в заголовке таблицы.

![Просмотр результата](/materials/7.png) 

## Работа с асинхронной моделью
В качестве примера асинхронной модели в данном приложении выступает модель *асинхронный калькулятор*. Заполните поля формы модели, нажмите на кнопку *произвести моделирование*. Элементы ввода и сама кнопка при этом станут не активны для взаимодействия с пользователем, на кнопке появится спиннер, сигнализирующий о выполнении вычислений.

![Форма асинхронной модели](/materials/8.png) 

Вычисления будут производиться 30 секунд. В это время можно перейти к работе с другими моделями или выйти из приложения. Когда вычисления будут завершены, в верхней левой части экрана появится индикация в виде черного колокольчика. При нажатии на данную иконку Вам будет выведен список из трех последних уведомлений. Просмотренные более двух секунд уведомления квитируются и больше не выводятся в области уведомлений. Уведомления зеленого цвета означают успешное завершение вычислений, красного - неудачное. Вы можете перейти к асинхронной модели и ознакомиться с результатом.

![Просмотр уведомлений](/materials/9.png) 